---
title: lego45544实现双轮自平衡机器人的控制算法核心备忘
date: 2017-04-28 16:56:40
tags: [算法,备忘]
categories: 技术&算法
---
## 算法核心

### - **双闭环pid并联控制算法**

- 单线程计算平衡控制参数
- 单线程计算行进控制参数

- 算法输入
    - 机器人本体角动量/角速度
    - 行进控制信号

- 算法输出
    - 伺服电机输出电压
    - 蜂鸣器输出电压
	
<!--more-->
## 算法过程

### - **平衡控制线程**
1. 系统启动后重置（RST）重置步进电机的角度传感器，陀螺仪，和CHK用计时器
2. 计算零漂(gOS)，方法是间隔0.004取200次陀螺仪的角速度取平均。但是这200次中最大和最小值之差要小于2。如果不满足，重新取200次，存入gOS
3. 喇叭响，屏幕显示Awake Up，st=1 （st 的用法下面解释）
4. 进入平衡姿态控制的循环
5. 计算每轮的所用平均时间（GT）： 第一轮重置计时器，并且假设第一轮0.014s，cLo+1.以后每轮都用总时间/cLo,得出平均时间，存入tInt
6. 平衡参数计算（GG）：先计算 gOS=0.0005*原始角速度+9.9995*gOS ，修正陀螺仪角速度误差（滤波的），（原始角速度-gOS）*iInt就是这轮的角度，再和前一轮角度相加，得到总的角度
7. 位移参数计算（GM）：因为移动量（水平位移）和电机转动成正比，所以移动量以电机转动的圈数为单位计算。首先计算出两个电机总的旋转度数，扣掉前一次的度数，算出这轮的位移。这次位移加上前一次的绝对位置（mPos）得出新值，更新mPos。然后以最近连续四次的位移的平均值除以/tInt算出平均位移速度。
8. PID计算（EQ)  如果期望机器人有水平方向的移动，那么一起算上（mPos= mPos - Cdrv \* tInt）。然后先计算平衡用数据gPwr=0.8\*gSpd+15\*gAng。然后计算水平移动数据mPwr=0.02\*mSpd+0.12\*mPos 。 最后合成的速度是gPwr+mPwr-0.01\*Cdrv (Cdrv为带符号功率参数。如Cdrv为正，最终功率将往负值偏移。因是负反馈，所以机器人向前运动。反之也然。谢谢4楼ntwuhuu提示)。然后限制功率在±100之间
9. 最终功率计算（cntrl） 再计算一次mPos （mPos=mPos-Cdrv*tInt，）。 然后根据机器人的旋转（CStr)，调整两轮的输出功率
10. 输出到两个电机
11. 检测机器人状态 （CHK）：如果连续1s功率输出绝对值都是在100，说明机器人倒了
12. 将这一轮补足到0.005秒
13. 如果机器人倒了，退出平衡循环，等待重置

### - **行进控制线程**
1. 初始状态st是零，直到平衡线程完成初始化，Awake Up，st=1
2. st=1的情况下，机器人向前运动4秒钟，完成平衡，st=2
3. st=2后，根据颜色传感器，发出前后左右停的指令
4. 当超声波发现前面有障碍后，会将Cdrv降到-10，随机选择一个方向让机器人后退